(function(f){f.validator.addMethod("regex",function(m,o,n){if(this.optional(o)){return true}var p=new RegExp(n).exec(m);return p&&p.index==0&&p[0].length==m.length});function h(n,m,o){n.range=[m,o]}function e(m,n){m.regex=n}function g(m){m.required=true}function k(m,n){m.maxlength=n}function l(m,n,o){m[n]=o}function b(p){var m={};for(var o=0;o<p.length;o++){var n=p[o];m[n.FieldName]="#"+n.ValidationMessageId}return m}function a(m){var u={};for(var n=0;n<m.length;n++){var s=m[n];var t={};u[s.FieldName]=t;var q=s.ValidationRules;for(var o=0;o<q.length;o++){var p=q[o];if(p.ErrorMessage){var r=p.ValidationType;switch(p.ValidationType){case"regularExpression":r="regex";break;case"stringLength":r="maxlength";break}t[r]=p.ErrorMessage}}}return u}function d(q){var m=q.ValidationRules;var p={};for(var n=0;n<m.length;n++){var o=m[n];switch(o.ValidationType){case"range":h(p,o.ValidationParameters.minimum,o.ValidationParameters.maximum);break;case"regularExpression":e(p,o.ValidationParameters.pattern);break;case"required":g(p);break;case"stringLength":k(p,o.ValidationParameters.maximumLength);break;default:l(p,o.ValidationType,o.ValidationParameters);break}}return p}function c(q){var n={};for(var m=0;m<q.length;m++){var p=q[m];var o=p.FieldName;n[o]=d(p)}return n}function i(p){var n=f("#"+p.FormId);var m=p.Fields;var o=c(m);var r=b(m);var q=a(m);var s={errorClass:"input-validation-error",errorElement:"span",errorPlacement:function(t,u){var v=r[u.attr("name")];f(v).empty().removeClass("field-validation-valid").addClass("field-validation-error");t.removeClass("input-validation-error").attr("_for_validation_message",v).appendTo(v)},messages:q,rules:o,success:function(u){var t=f(u.attr("_for_validation_message"));f(t).empty().addClass("field-validation-valid").removeClass("field-validation-error")}};n.validate(s)}var j=f.telerik;j.editing={};j.editing.initialize=function(n){f.extend(n,this.implementation);var m=f(n.element);if(n.isAjax()){m.delegate(".t-grid-edit","click",j.stopAll(function(o){n.editRow(f(this).closest("tr"))})).delegate(".t-grid-cancel","click",j.stopAll(function(o){n.cancel()})).delegate(".t-grid-delete","click",j.stopAll(function(o){n.deleteRow(f(this).closest("tr"))})).delegate(".t-grid-update","click",j.stopAll(function(o){n.save(this,f.proxy(function(){n.updateRow(f(this).closest("form").closest("tr"))},this))})).delegate(".t-grid-add","click",j.stopAll(function(o){n.addRow()})).delegate(".t-grid-insert","click",j.stopAll(function(o){n.save(this,f.proxy(function(){n.insertRow(f(this).closest("form").closest("tr"))},this))}))}else{m.delegate(".t-grid-delete","click",j.stop(function(o){if(n.editing.confirmDelete!==false&&!confirm(n.localization.deleteConfirmation)){o.preventDefault()}}));n.validation()}m.delegate(":input:not(.t-button)","keydown",j.stop(function(p){var o={13:".t-grid-update, .t-grid-insert",27:".t-grid-cancel"};f(this).closest("tr").find(o[p.keyCode]).click()}))};j.editing.implementation={insertRow:function(m){this.sendValues(this.extractValues(m),"insertUrl")},updateRow:function(m){this.sendValues(this.extractValues(m,true),"updateUrl")},deleteRow:function(m){if(this.editing.confirmDelete===false||confirm(this.localization.deleteConfirmation)){this.sendValues(this.extractValues(m,true),"deleteUrl")}},editRow:function(n){this.cancel();var o=new j.stringBuilder();this.form(o,[{name:"update"},{name:"cancel"}]);var p=this.dataItem(n);var m=f(o.string());var s=m.find("tr:first td:not(.t-group-cell)");var t=this.editing.mode;f.each(this.columns,function(u){if(this.edit){m.find(':input[name$="'+this.member+'"]').val(this.edit(p)+"").end().find(':checkbox[name$="'+this.member+'"]').attr("checked",this.edit(p)==true)}if(t=="InLine"&&this.readonly){s.eq(u).html(this.display(p))}});if(t!="PopUp"){n.html(m)}else{var r=f("<div />",{id:this.element.id+"PopUp"}).appendTo(this.element).data("tr",n);var q=j.stopAll(function(){r.data("tWindow").destroy()});r.css({top:0,left:"50%",marginLeft:-90}).tWindow(f.extend({title:this.localization.edit,onClose:q},this.editing.popup)).find("> .t-content").append(m).delegate(".t-grid-update","click",j.stopAll(function(u){this.save(u.target,f.proxy(function(){this.updateRow(r);r.data("tWindow").destroy()},this))},this)).delegate(".t-grid-cancel","click",q)}this.validation()},addRow:function(){this.cancel();var o=new j.stringBuilder();var n=this.editing.mode;if(n!="PopUp"){o.cat('<tr class="t-grid-new-row">');this.form(o,[{name:"insert"},{name:"cancel"}]);o.cat("</tr>");f(o.string()).prependTo(this.$tbody)}else{this.form(o,[{name:"insert"},{name:"cancel"}]);var m=f("<div />",{id:this.element.id+"PopUp",style:"top:0"}).appendTo(this.element);m.tWindow(f.extend({title:this.localization.addNew},this.editing.popup)).find("> .t-content").append(o.string()).delegate(".t-grid-insert","click",j.stopAll(function(p){this.save(p.target,f.proxy(function(){this.insertRow(m);m.data("tWindow").destroy()},this))},this)).delegate(".t-grid-cancel","click",j.stopAll(function(){m.data("tWindow").destroy()}))}this.validation()},extractValues:function(m,p){var q={};f.each(this.columns,function(){var r=this.member;if(this.edit){m.find(':input[name$="'+r+'"]').each(function(){q[r]=f(this).val()}).end().find(':checkbox[name$="'+r+'"]').each(function(){q[r]=f(this).attr("checked")})}});if(p){var o=this.dataItem(m.data("tr")||m);for(var n in this.dataKeys){q[this.ws?n:this.dataKeys[n]]=this.valueFor({member:n})(o)}}return q},cancelRow:function(m){if(!m.length){return}if(m.is(".t-grid-new-row")){m.remove();return}var n=this.dataItem(m);var o=new j.stringBuilder();o.rep('<td class="t-group-cell" />',this.groups.length);f.each(this.columns,f.proxy(function(p,q){o.cat("<td").cat(q.attr).catIf(' class="t-last"',p==this.columns.length-1).cat(">");if(q.display){o.cat(q.display(n))}this.appendCommandHtml(q.commands,o);o.cat("</td>")},this));m.html(o.string());j.trigger(this.element,"rowDataBound",{row:m[0],dataItem:n})},form:function(p,n){var o=this.$tbody.siblings("colgroup");var m=this.editing.mode;if(m!="PopUp"){p.cat('<td class="t-edit-container" colspan="').cat(this.columns.length+this.groups.length).cat('">')}p.cat('<form class="t-edit-form" action="#" method="post" id="').cat(this.formId()).cat('">');if(m=="InLine"){p.cat('<table cellspacing="0"><colgroup>');this.$tbody.siblings("colgroup").children().each(function(){p.cat('<col style="width:').cat(f(this).css("width")).cat('" />')});p.cat("</colgroup><tbody><tr>").rep('<td class="t-groupcell" />',this.groups.length);f.each(this.columns,f.proxy(function(q,r){p.cat("<td").cat(r.attr).catIf(' class="t-last"',q==this.columns.length-1).cat(">").catIf(r.editor,r.editor).catIf("&nbsp;",!r.editor&&!r.commands);if(r.commands){this.appendCommandHtml(n,p)}p.cat("</td>")},this));p.cat("</tr></tbody></table>")}else{p.cat('<div class="t-edit-form-container">').cat(this.editing.editor).cat("<div>");f.each(this.columns,f.proxy(function(q,r){if(r.commands){this.appendCommandHtml(n,p)}},this));p.cat("</div></div>")}p.cat("</form>");p.catIf("</td>",m!="PopUp")},save:function(m,n){f(m).closest("form").validate().form()&&n()},cancel:function(){this.cancelRow(f("#"+this.formId()).closest("tr"))},sendValues:function(q,m){if(this.ws){for(var n in q){var p=this.columnFromMember(n);if(p&&p.type=="Date"){var o=new Date(Date.parse(q[n]));q[n]="\\/Date("+o.getTime()+")\\/"}}}f.ajax(this.ajaxOptions({data:this.ws?{value:q}:q,url:this.url(m)}))},formId:function(){return f(this.element).attr("id")+"form"},validation:function(){if(window.mvcClientValidationMetadata){var m=this.formId();var n=f.grep(window.mvcClientValidationMetadata,function(o){return o.FormId==m})[0];if(n){n.Fields=f.grep(n.Fields,f.proxy(function(o){var p=this.columnFromMember(o.FieldName);return !p||p.type!="Boolean"},this));i(n)}}}}})(jQuery);